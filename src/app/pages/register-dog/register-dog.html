<div class="register-container">
  <!-- Header -->
  <div class="header">
    <button mat-icon-button (click)="previousStep()" [disabled]="currentStep() === 1">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Register Your Dog</h1>
    <button mat-icon-button routerLink="/match">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Progress Bar -->
  <div class="progress-section">
    <mat-progress-bar [value]="progressPercentage" mode="determinate"></mat-progress-bar>
    <p class="progress-text">Step {{ currentStep() }} of {{ totalSteps }}</p>
  </div>

  <!-- Form Content -->
  <div class="content">
    <form [formGroup]="dogForm">
      <!-- Step 1: Basic Information -->
      @if (currentStep() === 1) {
        <div class="step step-1" [@fadeIn]>
          <h2>Basic Information</h2>
          <p class="step-description">Tell us about your furry friend</p>

          <!-- Image Upload -->
          <app-image-upload
            [initialImage]="dogImageUrl() || undefined"
            buttonText="Upload Dog Photo"
            aspectRatio="square"
            (imageSelected)="onImageSelected($event)"
            (imageRemoved)="onImageRemoved()"
          ></app-image-upload>

          <mat-form-field appearance="outline">
            <mat-label>Dog's Name</mat-label>
            <input matInput formControlName="name" placeholder="e.g., Max">
            @if (dogForm.get('name')?.hasError('required') && dogForm.get('name')?.touched) {
              <mat-error>Name is required</mat-error>
            }
            @if (dogForm.get('name')?.hasError('minlength')) {
              <mat-error>Name must be at least 2 characters</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Breed</mat-label>
            <input
              matInput
              formControlName="breed"
              [matAutocomplete]="auto"
              (input)="onBreedInput($event)"
              placeholder="Search for a breed">
            <mat-autocomplete #auto="matAutocomplete">
              @for (breed of filteredBreeds(); track breed) {
                <mat-option [value]="breed">{{ breed }}</mat-option>
              }
            </mat-autocomplete>
            @if (dogForm.get('breed')?.hasError('required') && dogForm.get('breed')?.touched) {
              <mat-error>Breed is required</mat-error>
            }
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Age (years)</mat-label>
            <input matInput type="number" formControlName="age" placeholder="3">
            @if (dogForm.get('age')?.hasError('required') && dogForm.get('age')?.touched) {
              <mat-error>Age is required</mat-error>
            }
            @if (dogForm.get('age')?.hasError('min') || dogForm.get('age')?.hasError('max')) {
              <mat-error>Age must be between 0 and 25</mat-error>
            }
          </mat-form-field>

          <div class="gender-selector">
            <label>Gender</label>
            <mat-radio-group formControlName="gender" class="gender-group">
              <mat-radio-button value="male">
                <mat-icon>male</mat-icon>
                Male
              </mat-radio-button>
              <mat-radio-button value="female">
                <mat-icon>female</mat-icon>
                Female
              </mat-radio-button>
            </mat-radio-group>
          </div>
        </div>
      }

      <!-- Step 2: Physical & Energy -->
      @if (currentStep() === 2) {
        <div class="step step-2" [@fadeIn]>
          <h2>Physical Traits</h2>
          <p class="step-description">Help us find the perfect match</p>

          <div class="size-selector">
            <label>Size</label>
            <div class="size-grid">
              @for (size of sizes; track size.value) {
                <div
                  class="size-card"
                  [class.selected]="dogForm.get('size')?.value === size.value"
                  (click)="dogForm.patchValue({ size: size.value })"
                >
                  <h3>{{ size.label }}</h3>
                  <p>{{ size.desc }}</p>
                </div>
              }
            </div>
          </div>

          <div class="energy-selector">
            <label>Energy Level</label>
            <div class="energy-grid">
              @for (level of energyLevels; track level.value) {
                <div
                  class="energy-card"
                  [class.selected]="dogForm.get('energy')?.value === level.value"
                  (click)="dogForm.patchValue({ energy: level.value })"
                >
                  <span class="energy-icon">{{ level.icon }}</span>
                  <span class="energy-label">{{ level.label }}</span>
                </div>
              }
            </div>
          </div>
        </div>
      }

      <!-- Step 3: Activities & Bio -->
      @if (currentStep() === 3) {
        <div class="step step-3" [@fadeIn]>
          <h2>Activities & Interests</h2>
          <p class="step-description">What does your dog love to do?</p>

          <div class="activities-selector">
            <label>Favorite Activities (select at least one)</label>
            <div class="activities-grid">
              @for (activity of activities; track activity) {
                <div
                  class="activity-chip"
                  [class.selected]="isActivitySelected(activity)"
                  (click)="toggleActivity(activity)"
                >
                  <mat-icon>{{ isActivitySelected(activity) ? 'check_circle' : 'radio_button_unchecked' }}</mat-icon>
                  {{ activity }}
                </div>
              }
            </div>
            @if (dogForm.get('activities')?.hasError('required') && dogForm.get('activities')?.touched) {
              <span class="error-text">Please select at least one activity</span>
            }
          </div>

          <mat-form-field appearance="outline" class="bio-field">
            <mat-label>Bio (Optional)</mat-label>
            <textarea
              matInput
              formControlName="bio"
              rows="4"
              placeholder="Tell us about your dog's personality, favorite toys, or anything that makes them special!"
            ></textarea>
            <mat-hint align="end">{{ dogForm.get('bio')?.value?.length || 0 }} / 300</mat-hint>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Province</mat-label>
            <input
              matInput
              formControlName="city"
              [matAutocomplete]="provinceAuto"
              (input)="onProvinceInput($event)"
              placeholder="Search for a province">
            <mat-autocomplete #provinceAuto="matAutocomplete">
              @for (province of filteredProvinces(); track province) {
                <mat-option [value]="province">{{ province }}</mat-option>
              }
            </mat-autocomplete>
            @if (dogForm.get('city')?.hasError('required') && dogForm.get('city')?.touched) {
              <mat-error>Province is required</mat-error>
            }
          </mat-form-field>
        </div>
      }
    </form>
  </div>

  <!-- Action Buttons -->
  <div class="actions">
    @if (currentStep() < totalSteps) {
      <button
        mat-raised-button
        color="primary"
        class="next-btn"
        [disabled]="!canProceed"
        (click)="nextStep()"
      >
        Continue
        <mat-icon>arrow_forward</mat-icon>
      </button>
    } @else {
      <button
        mat-raised-button
        color="primary"
        class="submit-btn"
        [disabled]="!dogForm.valid"
        (click)="submitForm()"
      >
        Complete Registration
        <mat-icon>check</mat-icon>
      </button>
    }
  </div>
</div>
